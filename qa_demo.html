<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>哈力馨GPT智能诊疗系统</title>
  <link rel="stylesheet" id="qa-style" href="qa.css">
  <link rel="stylesheet" id="medical-record-style" href="medical_record.css" disabled>
</head>

<body>
<div class="sidebar" id="progress-sidebar">
  <div class="sidebar-title">哈力馨GPT智能诊疗系统</div>
  <div id="step1" class="sidebar-item active">主诉</div>
  <div id="step2" class="sidebar-item">现病史</div>
  <div id="step3" class="sidebar-item">既往史</div>
  <div id="step4" class="sidebar-item">个人史</div>
  <div id="step5" class="sidebar-item">家族史</div>
  <div id="step6" class="sidebar-item">体格检查</div>
  <div id="step7" class="sidebar-item">专科检查</div>
  <div id="step8" class="sidebar-item">辅助检查</div>
  <div id="step9" class="sidebar-item">其他信息</div>
  <div id="step10" class="sidebar-item">病历生成</div>
</div>

<div class="main-content" id="main-content">
  <div id="step1-content" class="content">
    <div class="question">请问您今天主要有什么不适？（主诉）</div>
    <label>
    <textarea id="chief-complaint" class="input-field" >
    </textarea>
    </label>
    <button class="next-button" onclick="nextStep()">下一步</button>
  </div>
</div>

<div class="result-sidebar" id="result-sidebar">
  <div>西医诊断结果</div>
  <div id="western-diagnosis">
    <div class="result-item main">诊断1</div>
    <div class="result-item">诊断2</div>
    <div class="result-item">诊断3</div>
  </div>
  <div>中医诊断结果</div>
  <div id="chinese-diagnosis">
    <div class="result-item main">诊断1</div>
    <div class="result-item">诊断2</div>
    <div class="result-item">诊断3</div>
  </div>
</div>

<script>
  let currentStep = 1;
  const steps = 10;
  let medical_record = "";

  document.addEventListener("DOMContentLoaded", () => {
    fetch('./template.json')
            .then(response => response.json())
            .then(data => {
              medical_record = data.medical_record;
            })
            .catch(error => console.error('Error loading long string:', error));
  });


  function nextStep() {
    if (currentStep < steps-1) {
      document.getElementById(`step${currentStep}`).classList.remove("active");
      document.getElementById(`step${currentStep + 1}`).classList.add("active");
      document.getElementById(`step${currentStep}-content`).classList.add("hidden");

      currentStep++;
      const nextContent = document.createElement('div');
      nextContent.id = `step${currentStep}-content`;
      nextContent.classList.add('content');
      nextContent.innerHTML = `
                    <div class="question">问题 ${currentStep}</div>
                    <input type="text" id="answer${currentStep}" class="input-field" />
                    <button class="next-button" onclick="nextStep()">下一步</button>
                `;
      document.getElementById('main-content').appendChild(nextContent);
      console.log(currentStep)
    } else {
      generateReport();
    }
  }

  function generateReport() {

    toggleStylesheet()

    document.getElementById(`step${currentStep}`).classList.remove("active");
    document.getElementById(`step${currentStep + 1}`).classList.add("active");
    document.getElementById(`step${currentStep}-content`).classList.add("hidden");

    const nextContent = document.createElement('div');
    nextContent.id = `step${currentStep}-content`;
    nextContent.classList.add('content');
    nextContent.innerHTML = medical_record;
    document.getElementById('main-content').appendChild(nextContent);
  }

  function toggleStylesheet() {
    const defaultStyle = document.getElementById('qa-style');
    const alternateStyle = document.getElementById('medical-record-style');

    if (defaultStyle.disabled) {
      defaultStyle.disabled = false;
      alternateStyle.disabled = true;
    } else {
      defaultStyle.disabled = true;
      alternateStyle.disabled = false;
    }
  }

  function downloadDocx() {
    const record = document.getElementById('recordOutput').value;
    const doc = new docx.Document({
      sections: [
        {
          children: [
            new docx.Paragraph({
              children: [
                new docx.TextRun(record),
              ],
            }),
          ],
        },
      ],
    });

    // Create a mime type that will associate the new file with Microsoft Word
    const mimeType =
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document";
    let patient_name = record.substring(record.search("姓  名:"), record.search("工作单位：")).trim();
    patient_name = patient_name==="" ? "病人病历" : patient_name;
    const fileName = patient_name + '.docx';
    // Create a Blob containing the Document instance and the mimeType
    docx.Packer.toBlob(doc).then(blob => {
      const docblob = blob.slice(0, blob.size, mimeType);
      // Save the file using saveAs from the file-saver package
      saveAs(docblob, fileName);
    });
  }
</script>
</body>

</html>
